# SNS
A reusable module for creating SNS topics and subscriptions for notifications.
* [Home](#SNS)
* [Usage](#usage)
* [Inputs](#inputs)
* [Outputs](#outputs)
## Usage
In order to consume this module you will need to create [1 file](#the-1-file-method) for one-time use, or [3 files](#the-3-file-method) for reusability. Both uses will be explained.
### The 3 file method
The three file method uses 3 files, a main.tf, variables.tf, and a .tfvars file. The reusability lies in the .tfvars file. The main.tf will hold the module code shown below. The variables will be taken from the other 2 files needed and will be explained
###### main.tf
```HCL
provider "aws" {
    region = "${var.region}"
}

module "ta_sns_topic" {
    source                                   = "git::http://bitbucket.us.aegon.com/scm/dop/transamerica.cloud.module.sns.git"                 
    account_number                           = var.account_number # Account number to create the resource in
    count                                    = var.create > 0 ? var.create : 0 # How many resources you want created
    name                                     = "${var.department}-${var.application}-${var.environment}-${var.name_suffix}-${count.index}" #(Optional) The friendly name for the SNS topic. By default generated by Terraform.
    display_name                             = var.display_name #(Optional) The display name for the SNS topic
    policy                                   = var.policy #(Optional) The fully-formed AWS policy as JSON
    delivery_policy                          = var.delivery_policy #(Optional) The SNS delivery policy
    application_success_feedback_role_arn    = var.application_success_feedback_role_arn #(Optional) The IAM role permitted to receive success feedback for this topic
    application_success_feedback_sample_rate = var.application_success_feedback_sample_rate #(Optional) Percentage of success to sample
    application_failure_feedback_role_arn    = var.application_failure_feedback_role_arn #(Optional) IAM role for failure feedback
    http_success_feedback_role_arn           = var.http_success_feedback_role_arn #(Optional) The IAM role permitted to receive success feedback for this topic
    http_success_feedback_sample_rate        = var.http_success_feedback_sample_rate #(Optional) Percentage of success to sample
    http_failure_feedback_role_arn           = var.http_failure_feedback_role_arn #(Optional) IAM role for failure feedback
    lambda_success_feedback_role_arn         = var.lambda_success_feedback_role_arn #(Optional) The IAM role permitted to receive success feedback for this topic
    lambda_success_feedback_sample_rate      = var.lambda_success_feedback_sample_rate #(Optional) Percentage of success to sample
    lambda_failure_feedback_role_arn         = var.lambda_failure_feedback_role_arn #(Optional) IAM role for failure feedback
    sqs_success_feedback_role_arn            = var.sqs_success_feedback_role_arn #(Optional) The IAM role permitted to receive success feedback for this topic
    sqs_success_feedback_sample_rate         = var.sqs_success_feedback_sample_rate #(Optional) Percentage of success to sample
    sqs_failure_feedback_role_arn            = var.sqs_failure_feedback_role_arn #(Optional) IAM role for failure feedback
    kms_master_key_id                        = var.kms_master_key_id #(Optional) The ID of an AWS-managed customer master key (CMK) for Amazon SNS or a custom CMK
    protocol                                 = var.protocol # (Required) The protocol to use. The possible values for this are: sqs, sms, lambda, application. (http or https are partially supported, email is an option but is unsupported)
    endpoint                                 = var.endpoint # (Required) The endpoint to send data to, the contents will vary with the protocol
    endpoint_auto_confirms                   = var.endpoint_auto_confirms # (Optional) Boolean indicating whether the end point is capable of auto confirming subscription e.g., PagerDuty (default is false)
    confirmation_timeout_in_minutes          = var.confirmation_timeout # (Optional) Integer indicating number of minutes to wait in retying mode for fetching subscription arn before marking it as failure. Only applicable for http and https protocols (default is 1 minute)
    raw_message_delivery                     = var.raw_message_delivery # (Optional) Boolean indicating whether or not to enable raw message delivery (the original message is directly passed, not wrapped in JSON with the original message in the message property) (default is false)
    delivery_policy                          = var.delivery_policy # (Optional) JSON String with the filter policy that will be used in the subscription to filter messages seen by the target resource
    filter_policy                            = var.filter_policy # (Optional) JSON String with the delivery policy (retries, backoff, etc.) that will be used in the subscription - this only applies to HTTP/S subscriptions
/*  The following variables have defaults, but can be overwritten by defining them like above. Not required in .tfvars file if happy with the default value for the variable
    region                                   = var.region # Region to deploy resources to (Defaults to us-east-1)
    count                                    = var.created # Used to determine if resource is created. (Defaults to 1)
*/    
}

```
The variables.tf file is just to initialize the variables that will be used. Note: All variables used in the main.tf file need to be initialized. You can specify defaults within the variables.tf file if you wish. Below is an example variables.tf file. We have only initialized the variables that do not have defaults.
###### variables.tf
```HCL
variable "account_number" {
  type        = string
  description = "Account number everything is executed in."
}

variable "environment" {
  type        = string
  description = " environment (DEV/TST/MDL/PRD)"
}

variable "billing_cost_center" {
  type        = string
  description = "provide a cost center for billing reporting"
}

variable "resource_contact" {
  type        = string
  description = "provide an email"
}

variable "resource_purpose" {
  type        = string
  description = "provide a discription of what your using this for"
}

variable "department" {
  type        = string
  description = "department that owns the resource (consumer)"
}

variable "application" {
  type        = string
  description = "application that uses the sns resource"
}

variable "division" {
  type        = string
  description = "Division responsible for resource (tag based on cloud custodian)"
}

```
The following file holds the values that will be used in the main.tf file. The variable name should match what is shown in the variables.tf file. The file name is arbitrary. Terraform will automatically pull the terraform.tfvars file without needing to be specified. If you use a different file name you will need to specify it using the -var-file parameter.
i.e. `terraform plan -var-file="dev.tfvars"`. Note: We are showing only the variables that do not have defaults. These are the bare minimum variables that need to be defined, as they do not have default values set. 
###### dev.tfvars
```HCL  
display_name              = "ta-individual-sns-test-CPUUtilization-sns"
name_suffix               = "frontend-alarm"
account_number            = "285346304581" # individual dev account
department                = "ta-individual"
division                  = "transamerica"
application               = "sns-test"
billing_cost_center       = "0701-TTA05010 Technology Life Support"
resource_contact          = "dinesh.kancherlapali@transamerica.com"
resource_purpose          = "Testing SNS module project"
environment               = "dev"
channel                   = "individual"
region                    = "us-east-1"
sns_subscriptions         = [
    {
        PROTOCOL          = "lambda"
        ENDPOINT          = "arn:aws:sns:us-east-1:285346304581:ta-individual-rpa-dev-ec2-CPUUtilization"
    },
    {
        PROTOCOL          = "sqs"
        ENDPOINT          = "arn:aws:sns:us-east-1:285346304581:ta-individual-rpa-dev-ec2-CPUUtilization"
    }
]

```
To execute the terraform for the above files you will need to specify the var file used:
```Shell
terraform init
terraform get -update
terraform plan -var-file=dev.tfvars
terraform apply
```
The get -update command downloads the lastest code for all modules used. This is a must to make sure you do not use outdated module code. You do not need to specify the var file in the apply as the values will be saved in the plan file the apply command executes. All variables that are used need to be initialized in the variables.tf file. If we wanted to change the region the prod cluster was executed in, we would need to initialized the variable in the variables.tf file as we did with the other variables. To avoid having the add the region variable to all .tfvars file, we would specify the default for the region as us-east-1 so we would only need to add the variable to the prod.tfvars file much like we did with the environment variable. We would need to add a line to the main.tf to use this region variable in the module execute.

### The 1 file method
We can do all these same steps with using just one file, the main.tf file. We would need to specify the variables as strings rather than pulling variables from a .tfvars files and initializing them in the variables.tf file. Below is an example of this.
###### main.tf
```HCL
provider "aws" {
  region = "us-east-1"
}
module "sns_topic" {
  source                    = "git::http://bitbucket.us.aegon.com/scm/dop/transamerica.cloud.module.sns.git"
  display_name              = "ta-individual-sns-test-CPUUtilization-sns"
  name_suffix               = "frontend-alarm"
  account_number            = "285346304581" # individual dev account
  department                = "ta-individual"
  division                  = "transamerica"
  application               = "sns-test"
  resource_purpose          = "Testing SNS module project"
  environment               = "dev"
  channel                   = "individual"
  protocol                  = "lambda"
  endpoint                  = "arn:aws:lambda:us-east-1:285346304581:*"
}
```
The disadvantage of doing the 1 file method is if you have multiple environments, you have to create a new main.tf file for each one, where as you could create a new .tfvars file for each environment you want and pass the file name to the plan command.

## Inputs
* Required
    * SNS topic and subscription source
        * Must be `"git::http://bitbucket.us.aegon.com/scm/dop/transamerica.cloud.module.sns.git"` Do Not change this value!
    * account_number
        * Account number to create the resource
    * topic_arn
        * The ARN of the SNS topic to subscribe to
    * protocol
        * The protocol to use. The possible values for this are: sqs, sms, lambda, application. (http or https are partially supported, email is an option but is unsupported)
    * endpoint
        * The endpoint to send data to, the contents will vary with the protocol
  
* Optional (have been defaulted)
    * count
        * Used to determine if resource is created. (Defaults to 1)
    * display_name
        * The display name for the SNS topic
    * policy
        * The fully-formed AWS policy as JSON
    * delivery_policy
        * The SNS delivery policy
    * application_success_feedback_role_arn
        * The IAM role permitted to receive success feedback for this topic
    * application_success_feedback_sample_rate
        * Percentage of success to sample
    * application_failure_feedback_role_arn
        * IAM role for failure feedback
    * http_success_feedback_role_arn
        * The IAM role permitted to receive success feedback for this topic
    * http_success_feedback_sample_rate
        * Percentage of success to sample
    * http_failure_feedback_role_arn
        * IAM role for failure feedback
    * lambda_success_feedback_role_arn
        * The IAM role permitted to receive success feedback for this topic
    * lambda_success_feedback_sample_rate
        * Percentage of success to sample
    * lambda_failure_feedback_role_arn
        * IAM role for failure feedback
    * sqs_success_feedback_role_arn
        * The IAM role permitted to receive success feedback for this topic
    * sqs_success_feedback_sample_rate
        * Percentage of success to sample
    * sqs_failure_feedback_role_arn
        * IAM role for failure feedback
    * kms_master_key_id
        * The ID of an AWS-managed customer master key (CMK) for Amazon SNS or a custom CMK
    * endpoint_auto_confirms
        * Boolean indicating whether the end point is capable of auto confirming subscription e.g., PagerDuty (default is false)
    * confirmation_timeout_in_minutes
        * Integer indicating number of minutes to wait in retying mode for fetching subscription arn before marking it as failure. Only applicable for http and https protocols (default is 1 minute)
    * raw_message_delivery
        * Boolean indicating whether or not to enable raw message delivery (the original message is directly passed, not wrapped in JSON with the original message in the message property) (default is false)
    * delivery_policy
        * JSON String with the filter policy that will be used in the subscription to filter messages seen by the target resource
    * filter_policy
        * JSON String with the delivery policy (retries, backoff, etc.) that will be used in the subscription - this only applies to HTTP/S subscriptions
    
* Shouldn't be changed or specified
    * region
        * Region the launch the resources in (defaults to us-east-1)

## Outputs
Below are the values returned by the module. you can retrieve them by using `"${module.#MODULE_NAME#.#VARIABLE_NAME#}"`
* id
  * The id (Name) that is created for the SNS topic and subscription